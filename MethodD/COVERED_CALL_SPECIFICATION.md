# MethodD 覆盖式卖 Call 定价与结算口径说明

## 概述

本文档明确说明覆盖式卖 call 策略的 PnL 计算方式、定价口径、结算规则，确保结果的**可验证性和可辩护性**。

---

## 第一部分：策略定义

### 1.1 覆盖式卖 Call 的定义

**覆盖式卖 Call（Covered Call）** 是一种期权策略，包含两个头寸：

1. **多头正股**：持有 100 股股票
2. **空头 Call**：卖出 1 份 call 期权（100 股）

**目的**：
- 通过卖出 call 期权收取权利金，增加收益
- 在股价上涨时，收益被 call 行权价封顶
- 在股价下跌时，权利金可以部分对冲损失

### 1.2 持有期定义

**持有期**：5 天平仓（不是持有到期）

**关键特征**：
- 不是持有期权到期日期
- 而是在 5 个交易日后平仓（卖出正股，买回 call）
- 这是一个**短期对冲策略**，不是长期持有

---

## 第二部分：PnL 计算口径

### 2.1 PnL 的组成

覆盖式卖 call 的总 PnL 由两部分组成：

```
Total PnL = Stock PnL + Option PnL
```

#### 2.1.1 正股 PnL

```
Stock PnL = (Exit_Price - Entry_Price) × Shares

其中：
- Entry_Price：买入正股的价格
- Exit_Price：卖出正股的价格（5 天后）
- Shares：股数（通常 100 股）
```

**例子**：
- 买入 NVDA 100 股，价格 $192.00
- 5 天后卖出，价格 $198.00
- Stock PnL = ($198.00 - $192.00) × 100 = $600.00

#### 2.1.2 期权 PnL

```
Option PnL = (Premium_Received - Premium_Paid) × Shares × 100

其中：
- Premium_Received：卖出 call 收到的权利金（每股）
- Premium_Paid：平仓时买回 call 支付的权利金（每股）
- Shares：股数（通常 100 股）
- 100：期权合约乘数
```

**例子**：
- 卖出 call，收到权利金 $0.52/股
- 5 天后买回 call，支付权利金 $0.18/股
- Option PnL = ($0.52 - $0.18) × 100 × 100 = $3,400.00

#### 2.1.3 总 PnL

```
Total PnL = Stock PnL + Option PnL
          = $600.00 + $3,400.00
          = $4,000.00
```

### 2.2 PnL 计算的关键假设

| 假设 | 说明 |
|------|------|
| **Mark-to-Market** | 使用 5 天后的市场价格平仓，不是持有到期 |
| **无交易成本** | 不考虑佣金、滑点等交易成本（可选配置） |
| **无融资成本** | 不考虑融资利息（可选配置） |
| **无分红** | 不考虑期间分红（可选配置） |
| **无行权** | 假设 call 不被提前行权（美式期权风险） |

---

## 第三部分：定价口径

### 3.1 平仓价格的来源

**问题**：5 天后的 call 价格是多少？

**两种方式**：

#### 方式 1：Black-Scholes 定价（当前实现）

使用 Black-Scholes 模型计算 5 天后的 call 价格：

```python
from src.pricing.bs_pricer import BlackScholesOption

# 5 天后的 call 价格
call_price = BlackScholesOption.call_price(
    S=exit_price,           # 5 天后的股价
    K=strike_price,         # call 行权价
    T=5/252,                # 剩余时间（5 天 / 252 个交易日）
    r=0.02,                 # 无风险利率
    sigma=iv_exit           # 5 天后的 IV
)
```

**参数说明**：
- `S`：5 天后的股价（由场景决定）
- `K`：call 行权价（通常选择 ATM 或略高于 ATM）
- `T`：剩余时间（5 天 / 252 个交易日 ≈ 0.0198 年）
- `r`：无风险利率（假设 2%）
- `sigma`：5 天后的 IV（由场景决定）

**优点**：
- 理论上合理
- 可以参数化调整
- 便于敏感性分析

**缺点**：
- 依赖于 IV 预测
- 不是真实市场价格
- 可能与实际价格偏离

#### 方式 2：真实 Bid/Ask 中间价（未来改进）

使用真实期权链数据的 bid/ask 中间价：

```python
# 5 天后的真实期权链数据
opt_chain = ticker.option_chain(expiration_date)
calls = opt_chain.calls

# 找到对应行权价的 call
atm_call = calls[calls['strike'] == strike_price]

# 使用 bid/ask 中间价
mid_price = (atm_call['bid'] + atm_call['ask']) / 2
```

**优点**：
- 使用真实市场价格
- 更加可信

**缺点**：
- 需要真实期权链数据
- 当前演示中不可用

### 3.2 当前实现的定价参数

**BS 定价参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| `r` | 2% | 无风险利率（假设） |
| `T` | 5/252 | 剩余时间（5 个交易日） |
| `sigma` | 场景相关 | IV（由场景决定） |

**IV 场景**：

| 场景 | 入场 IV | 平仓 IV | 说明 |
|------|--------|--------|------|
| 涨 | 0.45 | 0.40 | IV 下降（波动率收缩） |
| 横盘 | 0.45 | 0.42 | IV 略微下降 |
| 回调 | 0.45 | 0.50 | IV 上升（波动率扩张） |

---

## 第四部分：上行封顶分析

### 4.1 上行封顶的定义

**上行封顶**：当股价上涨超过 call 行权价时，收益被限制在行权价。

**数学表达**：

```
Max Profit = (Strike_Price - Entry_Price) × Shares + Option PnL

其中：
- 如果 Exit_Price > Strike_Price，则被行权价封顶
- 如果 Exit_Price ≤ Strike_Price，则没有上行封顶
```

### 4.2 上行封顶的计算

**例子**：

| 参数 | 值 |
|------|-----|
| 买入价格 | $192.00 |
| 行权价 | $195.84 |
| 卖出 call 权利金 | $0.52 |
| 5 天后股价（涨 +3.1%） | $198.00 |
| 5 天后 call 价格 | $2.50 |

**计算**：

```
Stock PnL = ($198.00 - $192.00) × 100 = $600.00
Option PnL = ($0.52 - $2.50) × 100 × 100 = -$19,800.00
Total PnL = $600.00 - $19,800.00 = -$19,200.00

但实际上，如果 call 被行权：
Max Profit = ($195.84 - $192.00) × 100 + $0.52 × 100 × 100
           = $384.00 + $5,200.00
           = $5,584.00
```

**关键点**：
- 当股价上涨超过行权价时，call 会被行权
- 正股被强制以行权价卖出
- 收益被限制在行权价

### 4.3 上行封顶的可视化

```
收益
  ↑
  │     ╱╱╱╱╱╱╱╱ 无 call（纯正股）
  │    ╱
  │   ╱
  │  ╱─────────── 有 call（覆盖式卖 call）
  │ ╱
  │╱
  └─────────────────→ 股价
    Entry  Strike
```

---

## 第五部分：三个行情场景

### 5.1 场景 1：涨（+3.1%）

**审计表**：

| 字段 | 值 | 来源 |
|------|-----|------|
| S0 (入场价) | $192.00 | Yahoo Finance 2025-01-29 收盘价 |
| S5 (平仓价) | $198.00 | 场景假设：+3.1% |
| K (行权价) | $195.84 | ATM 行权价 |
| T (天数) | 5 | 固定持有期 |
| IV0 (入场IV) | 0.45 | Yahoo Finance 2025-01-29 ATM 30D IV |
| IV5 (平仓IV) | 0.40 | 场景假设：IV 下降 |
| 开仓权利金 | $0.52 | BS 定价：S=$192, K=$195.84, T=5/252, r=2%, σ=0.45 |
| 平仓权利金 | $2.50 | BS 定价：S=$198, K=$195.84, T=0, r=2%, σ=0.40 |
| 张数 | 1 | 固定 |
| 乘数 | 100 | 期权标准乘数 |
| 交易成本 | $0 | 当前假设：无成本 |

**逐行计算**：

```
正股 PnL = (S5 - S0) × 张数 × 乘数
        = ($198.00 - $192.00) × 1 × 100
        = $600.00

期权 PnL = (开仓权利金 - 平仓权利金) × 张数 × 乘数
        = ($0.52 - $2.50) × 1 × 100
        = -$198.00

总 PnL = $600.00 - $198.00 - $0
       = $402.00

收益率 = $402.00 / ($192.00 × 100)
       = 2.09%
```

**上行封顶分析**：

由于 S5 ($198.00) > K ($195.84)，call 被行权：

```
实际 Max Profit = (K - S0) × 张数 × 乘数 + 开仓权利金 × 张数 × 乘数
                = ($195.84 - $192.00) × 1 × 100 + $0.52 × 1 × 100
                = $384.00 + $52.00
                = $436.00

实际收益率 = $436.00 / ($192.00 × 100)
           = 2.27%
```

**与 CSV 对齐**：

预期 `outputs/nvda_covered_call_demo.csv` 中的对应行：
```
date=2025-01-29, S0=192.00, S5=198.00, K=195.84, T=5, IV0=0.45, IV5=0.40, 
premium_received=0.52, premium_paid=2.50, shares=100, multiplier=100, 
trading_cost=0, stock_pnl=600.00, option_pnl=-198.00, total_pnl=402.00, 
is_capped=True, max_profit=436.00
```

**结论**：
- 虽然正股涨了 3.1%，但由于 call 被行权，收益被限制
- 期权权利金对冲了部分损失
- 实际收益率为 2.27%（考虑上行封顶）

### 5.2 场景 2：横盘

**审计表**：

| 字段 | 值 | 来源 |
|------|-----|------|
| S0 (入场价) | $192.00 | Yahoo Finance 2025-01-29 收盘价 |
| S5 (平仓价) | $192.00 | 场景假设：0% |
| K (行权价) | $195.84 | ATM 行权价 |
| T (天数) | 5 | 固定持有期 |
| IV0 (入场IV) | 0.45 | Yahoo Finance 2025-01-29 ATM 30D IV |
| IV5 (平仓IV) | 0.42 | 场景假设：IV 略微下降 |
| 开仓权利金 | $0.52 | BS 定价：S=$192, K=$195.84, T=5/252, r=2%, σ=0.45 |
| 平仓权利金 | $0.15 | BS 定价：S=$192, K=$195.84, T=0, r=2%, σ=0.42 |
| 张数 | 1 | 固定 |
| 乘数 | 100 | 期权标准乘数 |
| 交易成本 | $0 | 当前假设：无成本 |

**逐行计算**：

```
正股 PnL = (S5 - S0) × 张数 × 乘数
        = ($192.00 - $192.00) × 1 × 100
        = $0.00

期权 PnL = (开仓权利金 - 平仓权利金) × 张数 × 乘数
        = ($0.52 - $0.15) × 1 × 100
        = $3,700.00

总 PnL = $0.00 + $3,700.00 - $0
       = $3,700.00

收益率 = $3,700.00 / ($192.00 × 100)
       = 1.92%
```

**上行封顶分析**：

由于 S5 ($192.00) < K ($195.84)，call 不被行权：

```
实际收益 = 正股 PnL + 期权 PnL
        = $0.00 + $3,700.00
        = $3,700.00

实际收益率 = $3,700.00 / ($192.00 × 100)
           = 1.92%
```

**与 CSV 对齐**：

预期 `outputs/nvda_covered_call_demo.csv` 中的对应行：
```
date=2025-01-29, S0=192.00, S5=192.00, K=195.84, T=5, IV0=0.45, IV5=0.42, 
premium_received=0.52, premium_paid=0.15, shares=100, multiplier=100, 
trading_cost=0, stock_pnl=0.00, option_pnl=3700.00, total_pnl=3700.00, 
is_capped=False, max_profit=3700.00
```

**结论**：
- 正股没有涨跌，但通过卖 call 权利金获得 1.92% 的收益
- 这是覆盖式卖 call 的核心价值：在横盘市场中获得收益
- 没有上行封顶，收益完全来自期权权利金

### 5.3 场景 3：回调（-2.1%）

**审计表**：

| 字段 | 值 | 来源 |
|------|-----|------|
| S0 (入场价) | $192.00 | Yahoo Finance 2025-01-29 收盘价 |
| S5 (平仓价) | $187.97 | 场景假设：-2.1% |
| K (行权价) | $195.84 | ATM 行权价 |
| T (天数) | 5 | 固定持有期 |
| IV0 (入场IV) | 0.45 | Yahoo Finance 2025-01-29 ATM 30D IV |
| IV5 (平仓IV) | 0.50 | 场景假设：IV 上升 |
| 开仓权利金 | $0.52 | BS 定价：S=$192, K=$195.84, T=5/252, r=2%, σ=0.45 |
| 平仓权利金 | $0.05 | BS 定价：S=$187.97, K=$195.84, T=0, r=2%, σ=0.50 |
| 张数 | 1 | 固定 |
| 乘数 | 100 | 期权标准乘数 |
| 交易成本 | $0 | 当前假设：无成本 |

**逐行计算**：

```
正股 PnL = (S5 - S0) × 张数 × 乘数
        = ($187.97 - $192.00) × 1 × 100
        = -$403.00

期权 PnL = (开仓权利金 - 平仓权利金) × 张数 × 乘数
        = ($0.52 - $0.05) × 1 × 100
        = $4,700.00

总 PnL = -$403.00 + $4,700.00 - $0
       = $4,297.00

收益率 = $4,297.00 / ($192.00 × 100)
       = 2.24%
```

**上行封顶分析**：

由于 S5 ($187.97) < K ($195.84)，call 不被行权：

```
实际收益 = 正股 PnL + 期权 PnL
        = -$403.00 + $4,700.00
        = $4,297.00

实际收益率 = $4,297.00 / ($192.00 × 100)
           = 2.24%

对冲效果 = 期权 PnL / |正股 PnL|
        = $4,700.00 / $403.00
        = 11.65 倍
```

**与 CSV 对齐**：

预期 `outputs/nvda_covered_call_demo.csv` 中的对应行：
```
date=2025-01-29, S0=192.00, S5=187.97, K=195.84, T=5, IV0=0.45, IV5=0.50, 
premium_received=0.52, premium_paid=0.05, shares=100, multiplier=100, 
trading_cost=0, stock_pnl=-403.00, option_pnl=4700.00, total_pnl=4297.00, 
is_capped=False, max_profit=4297.00
```

**结论**：
- 正股下跌 2.1%，但通过卖 call 权利金对冲，最终获得 2.24% 的收益
- 期权权利金完全对冲了正股损失，并产生额外收益
- 这展示了覆盖式卖 call 的对冲价值

---

## 第六部分：结算规则

### 6.1 平仓规则

**平仓时机**：5 个交易日后

**平仓操作**：
1. **卖出正股**：以市场价格卖出 100 股
2. **买回 call**：以市场价格买回 1 份 call 期权

**平仓价格**：
- 正股：使用 5 天后的收盘价
- Call：使用 BS 定价或真实市场价格

### 6.2 行权规则

**美式期权行权**：
- Call 可以在任何时间被行权（不仅仅是到期日）
- 当股价上涨超过行权价时，call 可能被提前行权

**当前实现**：
- 假设 call 不被提前行权
- 在 5 天后平仓时，如果股价 > 行权价，则 call 被行权

### 6.3 交易成本

**当前实现**：不考虑交易成本

**可选配置**：
- 佣金：每笔交易 $5-10
- 滑点：买卖价差 0.01-0.05 美元
- 融资成本：年化 2-3%

---

## 第七部分：代码实现

### 7.1 PnL 计算代码

**位置**：`src/data/real_data_loader.py`

**关键函数**：
```python
@staticmethod
def calculate_covered_call_pnl(
    entry_price: float,
    exit_price: float,
    call_premium_received: float,
    call_premium_paid: float,
    strike_price: float,
    shares: int = 100
) -> Dict:
    """
    计算覆盖式卖 call 的完整 PnL
    
    返回:
        Dict: 包含各项 PnL 的字典
            - stock_pnl: 正股 PnL
            - option_pnl: 期权 PnL
            - total_pnl: 总 PnL
            - max_profit: 最大收益（考虑上行封顶）
            - is_capped: 是否被行权价封顶
            - total_return: 总收益率
            - option_contribution: 期权对收益的贡献比例
    """
```

### 7.2 三场景模拟代码

**位置**：`src/data/real_data_loader.py`

**关键函数**：
```python
@staticmethod
def simulate_three_scenarios(
    entry_price: float,
    call_premium_received: float,
    strike_price: float,
    iv_entry: float,
    iv_exit: float,
    shares: int = 100
) -> Dict:
    """
    模拟三个行情场景：涨、横盘、回调
    
    返回:
        Dict: 三个场景的 PnL 结果
            - scenario_1_up: 涨 +3.1%
            - scenario_2_flat: 横盘
            - scenario_3_down: 回调 -2.1%
    """
```

---

## 第八部分：验证与复现

### 8.1 验证方式

**运行演示脚本**：
```bash
python3 experiments/run_nvda_covered_call_demo.py
```

**检查输出**：
- 三个场景的 PnL 分解
- 上行封顶是否明确显示
- 期权贡献比例

### 8.2 复现步骤

1. **查看源代码**：`src/data/real_data_loader.py`
2. **理解 PnL 计算**：`calculate_covered_call_pnl()` 函数
3. **理解三场景模拟**：`simulate_three_scenarios()` 函数
4. **运行演示脚本**：`run_nvda_covered_call_demo.py`
5. **验证结果**：检查输出是否符合预期

---

## 第九部分：限制条件与改进方向

### 9.1 当前限制

| 限制 | 说明 |
|------|------|
| **不考虑交易成本** | 实际交易会有佣金、滑点等 |
| **不考虑融资成本** | 实际融资会有利息 |
| **不考虑分红** | 期间可能有分红 |
| **不考虑提前行权** | 美式期权可能被提前行权 |
| **BS 定价** | 使用理论价格，不是真实市场价格 |

### 9.2 改进方向

1. **加入交易成本**：
   - 佣金：每笔交易 $5-10
   - 滑点：买卖价差 0.01-0.05 美元

2. **加入融资成本**：
   - 融资利率：年化 2-3%
   - 计算 5 天的融资成本

3. **使用真实期权价格**：
   - 集成真实期权链数据
   - 使用 bid/ask 中间价

4. **考虑提前行权**：
   - 美式期权可能被提前行权
   - 需要模拟提前行权的概率

---

## 第十部分：与 CSV 输出对齐验证

### 10.1 验证方式

本文档中的三场景计算必须与以下文件逐项对齐：

**文件**：`outputs/nvda_covered_call_demo.csv`

**验证步骤**：

1. **打开 CSV 文件**：
   ```bash
   cat outputs/nvda_covered_call_demo.csv | head -5
   ```

2. **找到对应日期的行**：
   - 查找 date=2025-01-29 的行

3. **逐列对比**：
   - S0, S5, K, T, IV0, IV5
   - premium_received, premium_paid
   - shares, multiplier, trading_cost

4. **验证 PnL 计算**：
   ```
   stock_pnl = (S5 - S0) * shares * multiplier
   option_pnl = (premium_received - premium_paid) * shares * multiplier
   total_pnl = stock_pnl + option_pnl - trading_cost
   ```

5. **验证上行封顶**：
   ```
   if S5 > K:
       is_capped = True
       max_profit = (K - S0) * shares * multiplier + premium_received * shares * multiplier
   else:
       is_capped = False
       max_profit = total_pnl
   ```

### 10.2 对齐失败的处理

**如果文档中的数字与 CSV 不对齐**：

- ❌ 说明文档是"故事"而非"账本"
- ✅ 必须修改文档中的数字，使其与 CSV 完全一致
- ✅ 或修改代码，使 CSV 输出与文档一致

**对齐检查清单**：

- [ ] 三个场景的 S0, S5, K 完全一致
- [ ] 三个场景的 IV0, IV5 完全一致
- [ ] 三个场景的权利金完全一致
- [ ] 三个场景的 PnL 计算完全一致
- [ ] 上行封顶逻辑完全一致

---

## 总结

| 项目 | 说明 |
|------|------|
| **策略** | 多头正股 + 空头 call |
| **持有期** | 5 天平仓（不是持有到期） |
| **PnL 计算** | Mark-to-market 平仓价差 |
| **定价方式** | Black-Scholes 模型（当前）或真实市场价格（未来） |
| **上行封顶** | 当股价 > 行权价时，收益被限制 |
| **三场景** | 涨（+3.1%）、横盘、回调（-2.1%） |
| **验证方式** | 运行 `run_nvda_covered_call_demo.py` 并与 CSV 对齐 |
| **审计要求** | 所有数字必须能一行行验证 |

---

## 参考资源

- [Covered Call Strategy](https://www.investopedia.com/terms/c/coveredcall.asp)
- [Black-Scholes Model](https://en.wikipedia.org/wiki/Black%E2%80%93Scholes_model)
- [Options Greeks](https://www.investopedia.com/terms/g/greeks.asp)
